<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de Pago - Malok Recargas</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <style>
/* Estilos para el botÃ³n de copiar y el mensaje */
        .copy-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .copy-container .wallet-address {
            display: none; /* Oculta la direcciÃ³n real */
        }
        .copy-button {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        .copy-button:hover {
            background-color: #0056b3;
        }
        .copy-feedback {
            display: none;
            margin-left: 10px;
            color: #28a745;
            font-size: 0.9em;
            font-weight: bold;
        }
        /* Estilo para la etiqueta de la direcciÃ³n */
        .address-label {
            font-weight: bold;
            color: var(--text-color);
        }
        /* Estilo para los nuevos campos de correo y whatsapp */
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        .input-group input[type="email"],
        .input-group input[type="tel"],
        .input-group input[type="text"], /* AÃ±adido para Binance ID */
        .input-group input[type="password"] { /* AÃ±adido para Wallet */
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--input-background);
            color: var(--text-color);
            box-sizing: border-box; /* Asegura que el padding no aumente el ancho */
        }
        /* Estilo para el mensaje de Ã©xito */
        .payment-success-message {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--accent-green-light); /* Un color de fondo suave para el Ã©xito */
            border: 1px solid var(--accent-green);
            border-radius: 8px;
            text-align: center;
            color: var(--accent-green); /* Color del texto */
        }
        .payment-success-message h2 {
            margin-top: 0;
            color: var(--accent-green);
        }
        .payment-success-message p {
            margin-bottom: 0;
        }
        /* Estilos para los pasos */
        .form-section-step {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .form-section-step h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }
        /* Nuevo estilo para el contenedor de la contraseÃ±a */
        .password-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-password {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.1em;
            padding: 5px;
        }

        /* ðŸš€ FIX DE VISUALIZACIÃ“N DE BOTONES DE PAGO ðŸš€ */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* MÃ­nimo 140px de ancho */
            gap: 15px;
            margin-top: 10px;
        }

        .payment-method-option input[type="radio"] {
            display: none; /* Oculta el radio button nativo */
        }

        .payment-method-option label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            border: 2px solid var(--border-color, #ccc);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            height: 100%; /* Para que todos tengan la misma altura */
            background-color: var(--input-background); /* Asegurar color de fondo */
        }

        .payment-method-option label:hover {
            border-color: var(--primary-color, #007bff);
        }

        .payment-method-option input[type="radio"]:checked + label {
            border-color: var(--accent-green, #28a745);
            background-color: var(--accent-green-light, #e9f7ef);
            color: var(--text-color, #333);
        }

        .payment-method-option label i {
            font-size: 2em;
            margin-bottom: 8px;
            color: var(--primary-color, #007bff);
        }

        .payment-method-option input[type="radio"]:checked + label i {
            color: var(--accent-green, #28a745);
        }
        /* ------------------------------------------- */
    </style>
</head>
<body>
   <header>
    <div class="header-left">
        <a href="index.html" class="logo-link">
            <img src="images/malok_logo.png" alt="Malok Recargas Logo" class="logo-img">
        </a>
    </div>
    <div class="header-right">
        
        <div class="wallet-container" id="wallet-container" style="display:none;"> 
            <div class="wallet-display">
                <i class="fas fa-wallet"></i>
                <span id="virtual-balance">$. --.--</span>
            </div>
            <a href="rechargedwallet.html" class="recharge-btn" title="Recargar Saldo">
                <i class="fas fa-plus"></i>
            </a>
        </div>
        <div class="auth-dropdown" id="auth-dropdown">
            <button class="auth-btn" id="toggle-login-btn">
                <i class="fas fa-user-circle"></i>
                <img src="images/default_user.png" alt="Usuario" class="auth-user-picture" id="auth-user-picture" style="display:none;">
            </button>
            
            <div class="dropdown-content">
                <a href="#" class="auth-display-name" id="auth-display-name">Iniciar SesiÃ³n</a>
                <hr>
                
                <div id="google-login-btn" style="display: block;">
                    </div>
                
                <button id="logout-btn" class="logout-btn" style="display:none;">
                    <i class="fas fa-sign-out-alt"></i> Cerrar SesiÃ³n
                </button>
            </div>
        </div>
    </div>
</header>

    <main class="payment-main">
        <div class="form-container">
            <h2>Confirmar Recarga y Seleccionar MÃ©todo de Pago</h2>
            <div id="transaction-summary" class="transaction-summary">
            </div>

            <form id="payment-form">
                <div class="form-section-step">
                    <h3>Paso 1: Selecciona tu MÃ©todo de Pago</h3>
                    <div class="form-group">
                        <label>MÃ©todo de Pago:</label>
                        <div class="payment-methods" id="payment-methods">
                        </div>
                    </div>
                </div>

                <div class="form-section-step">
                    <h3>Paso 2: Realiza el Pago y Sube tu Comprobante</h3>
                    <div id="payment-details-form" class="payment-details-form">
                    </div>
                </div>
                
                <div class="form-section-step">
                    <h3>Paso 3: InformaciÃ³n de Contacto para Notificaciones</h3>
                    <div class="input-group">
                        <label for="email">Correo ElectrÃ³nico (Para notificaciones y factura):</label>
                        <input type="email" id="email" name="email" placeholder="tu_correo@ejemplo.com" required>
                    </div>

                    <div class="input-group">
                        <label for="whatsappNumber">NÃºmero de WhatsApp (Para contacto):</label>
                        <input type="tel" id="whatsappNumber" name="whatsappNumber" placeholder="Ej: 584121234567" required>
                    </div>
                </div>
                <div id="whatsapp-message-container" class="payment-confirmation-message" style="margin-top: 30px; margin-bottom: 20px; text-align: center; display: none;">
                    <p style="font-size: 1.1em; color: var(--text-color); margin-bottom: 15px;">
                        Â¡Importante! Una vez realizado el pago con el mÃ©todo seleccionado, <strong>envÃ­a la captura de tu comprobante y tus datos de TikTok</strong> al siguiente nÃºmero de WhatsApp para que tu recarga sea procesada rÃ¡pidamente:
                    </p>
                    <a href="https://wa.me/584126949631?text=Hola%2C%20acabo%20de%20realizar%20un%20pago%20para%20recarga%20de%20TikTok.%20Mis%20datos%20de%20TikTok%20son%3A%20%5BAQUI_TUS_DATOS%5D."
                        class="whatsapp-link"
                        target="_blank"
                        style="font-size: 1.1em; padding: 12px 25px;">
                        <i class="fab fa-whatsapp"></i> Enviar Captura al WhatsApp
                    </a>
                    <p class="small-text" style="margin-top: 15px;">
                        (Por favor, no olvides incluir tus datos de TikTok en el mensaje de WhatsApp).
                    </p>
                </div>

                <button type="submit" class="btn-primary" id="finalize-recharge-btn" disabled>Finalizar Recarga</button>
            </form>

            <div id="success-message-display" class="payment-success-message" style="display: none;">
                <h2>ðŸŽ‰ Â¡NotificaciÃ³n Enviada! ðŸŽ‰</h2>
                <p>Hemos recibido tu solicitud de recarga. Te enviaremos un correo de confirmaciÃ³n y la factura virtual una vez que tu recarga sea procesada.</p>
                <p>Â¡Gracias por usar Malok Recargas!</p>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Malok Recargas. Todos los derechos reservados.</p>
            <div class="footer-links">
                <a href="privacy.html">PolÃ­ticas de Privacidad</a>
                <a href="terms.html">TÃ©rminos de Servicio</a>
            </div>
            <a href="https://wa.me/584126949631" target="_blank" class="whatsapp-link">
                <i class="fab fa-whatsapp"></i> ContÃ¡ctanos por WhatsApp
            </a>
        </div>
    </footer>

<script src="script.js"></script>
<script>
// 1. PLANTILLAS Y DATOS ESTATICOS
    const paymentDetailsTemplates = {
        'pago-movil': `
            <p><strong>Paso 1:</strong> Realiza el Pago MÃ³vil a los siguientes datos:</p>
            <ul>
                <li><strong>Banco:</strong> Banco de Mercantil (0105)</li>
                <li class="copy-container">
                    <strong>CÃ©dula/RIF:</strong> <span id="pm-cedula">V-30258234</span>
                    <button type="button" class="copy-button" data-copy-target="pm-cedula"><i class="fas fa-copy"></i></button>
                    <span id="pm-cedula-copy-feedback" class="copy-feedback"></span>
                </li>
                <li class="copy-container">
                    <strong>TelÃ©fono:</strong> <span id="pm-telefono">0412-6949631</span>
                    <button type="button" class="copy-button" data-copy-target="pm-telefono"><i class="fas fa-copy"></i></button>
                    <span id="pm-telefono-copy-feedback" class="copy-feedback"></span>
                </li>
            </ul>
            <div class="payment-fields-container">
                <p><strong>Paso 2:</strong> Sube tu comprobante de pago.</p>
                <label for="payment-receipt">Subir Comprobante de Pago:</label>
                <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf" required>
            </div>
        `,
        // Plantilla para Plisio (RedirecciÃ³n de pago)
        'binance': `
            <div class="payment-fields-container">
                <p><strong>Paso 1:</strong> SerÃ¡s redirigido a la pasarela segura de Plisio para completar tu pago con criptomonedas.</p>
                <p><strong>Paso 2:</strong> Al finalizar el pago en la pasarela, serÃ¡s automÃ¡ticamente redirigido de vuelta. La confirmaciÃ³n del pago es automÃ¡tica.</p>
                <input type="hidden" id="payment-receipt" name="paymentReceipt" value="Plisio_Managed_Payment" required> 
            </div>
        `,
        // Plantilla para Zinli (Comprobante requerido)
        'zinli': `
            <p><strong>Paso 1:</strong> Transfiere el monto exacto a nuestra cuenta Zinli.</p>
            <ul>
                <li class="copy-container">
                    <strong>Usuario Zinli:</strong> <span id="zinli-email">miladelarocaedwar04@gmail.com</span>
                    <button type="button" class="copy-button" data-copy-target="zinli-email"><i class="fas fa-copy"></i></button>
                    <span id="zinli-email-copy-feedback" class="copy-feedback"></span>
                </li>
            </ul>
            <div class="payment-fields-container">
                <p><strong>Paso 2:</strong> Sube tu comprobante de pago.</p>
                <label for="payment-receipt">Subir Comprobante de Pago:</label>
                <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf" required>
            </div>
        `,
        // ðŸ†• NUEVA PLANTILLA: Binance Pay (Transferencia por ID)
        'binance-id': `
            <p><strong>Paso 1:</strong> Transfiere el monto exacto por Binance Pay a la siguiente ID:</p>
            <ul>
                <li class="copy-container">
                    <strong>Binance Pay ID (MUID):</strong> <span id="binance-muid">123456789</span>
                    <button type="button" class="copy-button" data-copy-target="binance-muid"><i class="fas fa-copy"></i></button>
                    <span id="binance-muid-copy-feedback" class="copy-feedback"></span>
                </li>
            </ul>
            <div class="payment-fields-container">
                <p><strong>Paso 2:</strong> Sube el comprobante de pago.</p>
                <label for="payment-receipt">Subir Comprobante de Pago:</label>
                <input type="file" id="payment-receipt" name="paymentReceipt" accept="image/*,application/pdf">
                </div>
        `,
        // ðŸŽ¯ Plantilla para Wallet
        'wallet': `
            <div class="payment-fields-container">
                <p><strong>Paso 1:</strong> Confirma la deducciÃ³n de <span id="wallet-final-price" style="font-weight: bold;"></span> de tu Wallet de la pÃ¡gina.</p>
                <p style="font-size: 0.9em; color: #ff9800;">(AsegÃºrate de tener saldo suficiente antes de continuar. La deducciÃ³n se harÃ¡ al presionar "Finalizar Recarga")</p>
                <input type="hidden" id="payment-receipt" name="paymentReceipt" value="Wallet_Deduction_Flow" required>
                </div>
        `
    };

    const paymentMethodsVES = [
        { id: 'pago-movil', name: 'Pago MÃ³vil', type: 'ves', icon: 'fas fa-mobile-alt' }
    ];

    const paymentMethodsUSD = [
        { id: 'binance', name: 'Binance (Pasarela)', type: 'usd', icon: 'fab fa-bitcoin' },
        { id: 'binance-id', name: 'Binance Pay (ID)', type: 'usd', icon: 'fas fa-money-check-alt' },
        { id: 'zinli', name: 'Zinli', type: 'usd', icon: 'fas fa-coins' },
    ];

    // ðŸŽ¯ CAMBIO CLAVE: Nueva lista para la moneda USDM (Solo Wallet)
    const paymentMethodsUSDM = [
        { id: 'wallet', name: 'Wallet (Saldo en PÃ¡gina)', type: 'usdm', icon: 'fas fa-wallet' }
    ];

    // 2. VARIABLES GLOBALES DE LA PAGINA
    let transactionDetails = null;
    const paymentForm = document.getElementById('payment-form');
    const whatsappMessageContainer = document.getElementById('whatsapp-message-container');
    const finalizeBtn = document.getElementById('finalize-recharge-btn');
    const successMessageDisplay = document.getElementById('success-message-display');
    const paymentDetailsFormDiv = document.getElementById('payment-details-form');
    const paymentMethodsDiv = document.getElementById('payment-methods'); 

    // 3. FUNCIONES DE LÃ“GICA
    
    /**
     * Busca y retorna el google_id de la transacciÃ³n.
     * @returns {string|null} El Google ID si se encuentra un Ã­tem de 'Recarga de Saldo', de lo contrario null.
     */
    function getGoogleIdFromTransaction() {
        // Aseguramos que transactionDetails sea un array
        const cartItems = Array.isArray(transactionDetails) ? transactionDetails : (transactionDetails ? [transactionDetails] : []);
        
        for (const item of cartItems) {
            // Buscamos especÃ­ficamente el item de 'Recarga de Saldo' que deberÃ­a contener el google_id
            if (item.game === 'Recarga de Saldo' && item.google_id) { 
                return item.google_id;
            }
        }
        return null; 
    }


    /**
     * Verifica si algÃºn Ã­tem en la transacciÃ³n requiere flujo asistido (TikTok/Telegram).
     * @returns {boolean}
     */
    function isAssistedFlow() {
        // Si no hay detalles, no es asistido
        if (!transactionDetails) return false;

        // Si es un array (carrito), verificamos si ALGUNO de los items es asistido
        if (Array.isArray(transactionDetails)) {
            return transactionDetails.some(item => 
                item.game === "TikTok" || item.game === "Telegram"
            );
        } 
        
        // Si es un objeto singular (flujo antiguo), verificamos ese objeto
        return transactionDetails.game === "TikTok" || transactionDetails.game === "Telegram";
    }

    /**
     * Genera y actualiza el enlace de WhatsApp para recargas asistidas.
     */
    function updateWhatsAppLink() {
        if (!isAssistedFlow()) return;

        const whatsappLink = document.querySelector('.whatsapp-link');
        const email = document.getElementById('email') ? document.getElementById('email').value.trim() : '';
        const whatsappNumber = document.getElementById('whatsappNumber') ? document.getElementById('whatsappNumber').value.trim() : '';
        const isEmailValid = document.getElementById('email') ? document.getElementById('email').checkValidity() : false;
        
        if (whatsappLink && email && isEmailValid && whatsappNumber && transactionDetails && transactionDetails.finalPrice) {
            
            let message = `Â¡Hola! Quiero confirmar mi pedido de recarga.\n\n*Pedido Asistido:*\n`;
            
            // Determinar si es un solo item o un carrito
            const cartItems = Array.isArray(transactionDetails) ? transactionDetails : (transactionDetails ? [transactionDetails] : []);
            
            let totalAmount = transactionDetails.finalPrice || 'N/A';
            let currency = transactionDetails.currency || 'USD';
            
            // ConstrucciÃ³n del mensaje con los detalles de la transacciÃ³n
            cartItems.forEach((item, index) => {
                // Solo listamos los Ã­tems que requieran asistencia
                if (item.game === "TikTok" || item.game === "Telegram") {
                    message += `\n*Item ${index + 1}:*\n`;
                    message += `*Juego/Servicio:* ${item.game}\n`;
                    message += `*Paquete:* ${item.packageName}\n`;
                    if (item.playerId) {
                        message += `*ID/Usuario:* ${item.playerId}\n`;
                    } else if (item.robloxEmail) {
                        message += `*Correo:* ${item.robloxEmail}\n`;
                    }
                }
            });
            
            message += `\n*TOTAL A PAGAR: ${currency} ${totalAmount}*\n\n`;
            message += `*Mi Correo:* ${email}\n`;
            message += `*Mi WhatsApp:* ${whatsappNumber}\n\n`;
            message += `_Adjunto el comprobante de pago en este chat._`;
            
            // Codificar el mensaje para la URL
            const encodedMessage = encodeURIComponent(message);
            
            // Actualizar el href del enlace de WhatsApp
            whatsappLink.href = `https://wa.me/584126949631?text=${encodedMessage}`;
        }
    }


    /**
     * @MODIFICADO: Muestra el resumen de la transacciÃ³n con los totales corregidos.
     */
    function updateTransactionSummary() {
        const summaryDiv = document.getElementById('transaction-summary');
        
        // Manejo de datos de transacciÃ³n (Aseguramos que siempre sea un array)
        const storedDetails = localStorage.getItem('transactionDetails');
        if (storedDetails) {
            transactionDetails = JSON.parse(storedDetails); 
        }

        // Si es un objeto singular (flujo antiguo), lo convertimos a un array.
        const cartItems = Array.isArray(transactionDetails) ? transactionDetails : (transactionDetails ? [transactionDetails] : []);
        
        if (!summaryDiv || cartItems.length === 0) {
            summaryDiv.innerHTML = '<p class="error-message">No se encontraron detalles de la recarga. Por favor, vuelve a la tienda.</p>';
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 10000);
            return;
        }

        const selectedCurrency = localStorage.getItem('selectedCurrency') || 'USD';
        const currencySymbol = selectedCurrency === 'VES' ? 'Bs.S' : '$';
        
        let totalUSD = 0; // Total con recargo (e.g., $1.13)
        let totalVES = 0;
        let totalUSDM = 0; // ðŸŽ¯ FIX 1: Nuevo total para USDM (Precio base sin recargo, e.g., $1.00)

        let summaryHTML = '<h3>Resumen de la TransacciÃ³n</h3>';
        summaryHTML += '<div class="product-list-summary">';

        // 1. Iterar sobre cada item del carrito
        cartItems.forEach((item, index) => {
            // Aseguramos que los precios sean nÃºmeros, usando 0 como fallback
            const priceUSD = parseFloat(item.priceUSD || 0);
            const priceVES = parseFloat(item.priceVES || 0);
            // ðŸŽ¯ FIX 2: Usamos un campo para el precio base (USDM). Se asume que el user lo carga como 'priceUSDM' o 'priceBaseUSD'.
            const priceUSDM = parseFloat(item.priceUSDM || item.priceBaseUSD || 0);

            // Acumular todos los totales
            totalUSD += priceUSD;
            totalVES += priceVES;
            totalUSDM += priceUSDM; // ðŸŽ¯ FIX 3: Acumular el total base

            let displayPrice = (selectedCurrency === 'VES' ? priceVES : priceUSD).toFixed(2);
            let gameOrServiceLabel = 'Juego';
            let game = item.game || 'Servicio';
            let playerInfoHtml = '';
            let passwordHtml = '';
            let passwordToReveal = null;

            // LÃ³gica para mostrar los campos de usuario/contraseÃ±a especÃ­ficos
            if (game === 'Free Fire' || game === 'Mobile Legends' || game === 'PUBG Mobile') {
                const gameIdHtml = item.playerId ? `<p><strong>ID de Jugador:</strong> ${item.playerId}</p>` : '';
                playerInfoHtml = gameIdHtml;
            } else if (game === 'Roblox') {
                const gameEmailHtml = item.robloxEmail ? `<p><strong>Correo de Roblox:</strong> ${item.robloxEmail}</p>` : '';
                const gamePasswordHtml = item.robloxPassword ? `<p><strong>ContraseÃ±a de Roblox:</strong> ${item.robloxPassword}</p>` : '';
                playerInfoHtml = `${gameEmailHtml}${gamePasswordHtml}`;
            } else if (game === 'Call of Duty Mobile') {
                const gameEmailHtml = item.codmEmail ? `<p><strong>Correo de ${game}:</strong> ${item.codmEmail}</p>` : '';
                if (item.codmPassword) {
                    passwordToReveal = item.codmPassword;
                }
                const gameVinculationHtml = item.codmVinculation ? `<p><strong>VinculaciÃ³n:</strong> ${item.codmVinculation}</p>` : '';
                playerInfoHtml = `${gameEmailHtml}${gameVinculationHtml}`;
            } else if (game === 'Recarga de Saldo' && item.google_id) { 
                // ðŸŽ¯ INICIO DEL CAMBIO: LÃ³gica para Recarga de Saldo/Wallet
                gameOrServiceLabel = 'Servicio';
                playerInfoHtml = `<p><strong>ID de Usuario (Google ID):</strong> ${item.google_id}</p>`;
                // ðŸŽ¯ FIN DEL CAMBIO
            } else {
                // Para otros juegos, mostramos el ID de Jugador (playerId)
                const playerIdHtml = item.playerId ? `<p><strong>ID/Usuario:</strong> ${item.playerId}</p>` : '';
                playerInfoHtml = playerIdHtml;
            }

            // Generar HTML de la contraseÃ±a si existe
            if (passwordToReveal) {
                const maskedPassword = 'â€¢'.repeat(passwordToReveal.length);
                passwordHtml = `
                    <p><strong>ContraseÃ±a:</strong> <span id="game-password-${index}">${maskedPassword}</span>
                        <button type="button" class="toggle-password" data-target-id="game-password-${index}" data-password="${passwordToReveal}">
                            <i class="fas fa-eye"></i>
                        </button>
                    </p>
                `;
            }

            // Creamos el HTML para el item actual
            summaryHTML += `
                <div class="product-summary-item" data-index="${index}">
                    <p class="item-name"><strong>${gameOrServiceLabel} (${game}):</strong> ${item.packageName}</p>
                    ${playerInfoHtml}
                    ${passwordHtml}
                    <p class="item-price">Precio: <span class="price-value">${currencySymbol} ${displayPrice}</span></p>
                </div>
                <hr>
            `;
        });
        
        // 2. Mostrar el Total Final
        const finalPrice = (selectedCurrency === 'VES' ? totalVES : totalUSD).toFixed(2);
        
        summaryHTML += `
            <div class="total-summary">
                <p><strong>TOTAL A PAGAR:</strong> <span class="price-value final-price">${currencySymbol} ${finalPrice}</span></p>
            </div>
        `;
        summaryHTML += '</div>';
        
        summaryDiv.innerHTML = summaryHTML;

        // 3. Actualizar el objeto transactionDetails global con los totales calculados
        transactionDetails.finalPrice = finalPrice;
        transactionDetails.currency = selectedCurrency;
        transactionDetails.totalUSD = totalUSD.toFixed(2);
        transactionDetails.totalVES = totalVES.toFixed(2);
        transactionDetails.totalUSDM = totalUSDM.toFixed(2); // ðŸŽ¯ FIX 4: Guardar el total base

        // 4. LÃ³gica para el botÃ³n de mostrar/ocultar contraseÃ±a
        setupPasswordToggle();

        // 5. Actualizar los mÃ©todos de pago
        updatePaymentMethods();

        // 6. Actualizar el link de WhatsApp (si aplica)
        updateWhatsAppLink();
    }


    /**
     * LÃ³gica para mostrar/ocultar contraseÃ±as.
     */
    function setupPasswordToggle() {
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-target-id');
                const password = button.getAttribute('data-password');
                const targetElement = document.getElementById(targetId);
                
                if (targetElement.textContent.includes('â€¢')) {
                    targetElement.textContent = password;
                    button.innerHTML = '<i class="fas fa-eye-slash"></i>';
                } else {
                    const maskedPassword = 'â€¢'.repeat(password.length);
                    targetElement.textContent = maskedPassword;
                    button.innerHTML = '<i class="fas fa-eye"></i>';
                }
            });
        });
    }

    /**
     * @MODIFICADO: Muestra los mÃ©todos de pago segÃºn la moneda seleccionada y el flujo Wallet.
     */
    function updatePaymentMethods() {
        if (!paymentMethodsDiv) return;
        paymentMethodsDiv.innerHTML = ''; 

        // Usamos transactionDetails.currency que fue establecido por updateTransactionSummary
        const currentCurrency = transactionDetails.currency; 
        let methods; 

        // ðŸŽ¯ CAMBIO CLAVE: Usamos 'let' y asignaciÃ³n condicional
        if (currentCurrency === 'VES') {
            methods = paymentMethodsVES;
        } else if (currentCurrency === 'USDM') { 
            // ðŸŽ¯ LÃ³gica para USDM: solo Wallet
            methods = paymentMethodsUSDM;
        } else {
            methods = paymentMethodsUSD; // Por defecto USD
        }

        methods.forEach(method => {
            const methodItem = document.createElement('div');
            methodItem.classList.add('payment-method-option');
            methodItem.innerHTML = `
                <input type="radio" id="method-${method.id}" name="paymentMethod" value="${method.id}" data-type="${method.type}">
                <label for="method-${method.id}">
                    <i class="${method.icon}"></i>
                    <span>${method.name}</span>
                </label>
            `;
            paymentMethodsDiv.appendChild(methodItem);
        });

        paymentMethodsDiv.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                const selectedMethodId = event.target.value;
                loadPaymentDetails(selectedMethodId);
                checkFormValidity();
            });
        });

        checkFormValidity();
    }

    /**
     * @MODIFICADO: Carga el HTML especÃ­fico para cada mÃ©todo de pago.
     */
    function loadPaymentDetails(methodId) {
        let methodHtml = paymentDetailsTemplates[methodId];
        
        if (methodHtml) {
            paymentDetailsFormDiv.innerHTML = methodHtml;
            
            // ðŸŽ¯ FIX 8: LÃ³gica especial para el mÃ©todo Wallet, usando totalUSDM.
            if (methodId === 'wallet') {
                const finalPriceElement = document.getElementById('wallet-final-price');
                // Ahora usa el totalUSDm calculado en updateTransactionSummary
                const finalPriceUSDM = transactionDetails.totalUSDM || transactionDetails.priceUSDM || '0.00';
                if (finalPriceElement) {
                    finalPriceElement.textContent = `$ ${parseFloat(finalPriceUSDM).toFixed(2)}`;
                }
            }

            // Re-adjuntar listeners de copia para elementos dinÃ¡micos
            document.querySelectorAll('.copy-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = button.getAttribute('data-copy-target');
                    const targetElement = document.getElementById(targetId);
                    const feedbackId = targetId + '-copy-feedback';
                    const feedbackElement = document.getElementById(feedbackId);
                    copyToClipboard(targetElement, feedbackElement);
                });
            });

        } else {
            paymentDetailsFormDiv.innerHTML = '<p>Por favor, selecciona un mÃ©todo de pago.</p>';
        }

        // Si se selecciona un mÃ©todo que requiere comprobante, activar el required en el input.
        const uploadReceiptInput = document.getElementById('payment-receipt');
        if (uploadReceiptInput) {
            if (methodId === 'pago-movil' || methodId === 'zinli' || methodId === 'binance-id') {
                uploadReceiptInput.setAttribute('required', 'required');
            } else {
                uploadReceiptInput.removeAttribute('required');
            }
        }
        
        // El botÃ³n 'Finalizar Recarga' debe estar disponible si se carga la secciÃ³n de detalles
        finalizeBtn.disabled = false;
        finalizeBtn.textContent = 'Finalizar Recarga';
    }


    /**
     * FunciÃ³n universal para copiar al portapapeles.
     */
    function copyToClipboard(element, feedbackElement) {
        if (element && navigator.clipboard) {
            try {
                navigator.clipboard.writeText(element.textContent.trim()).then(() => {
                    if (feedbackElement) {
                        feedbackElement.textContent = 'Â¡Copiado!';
                        feedbackElement.style.display = 'inline-block';
                        setTimeout(() => {
                            feedbackElement.style.display = 'none';
                        }, 1500);
                    }
                });
            } catch (err) {
                console.error('Error al copiar: ', err);
                if (feedbackElement) {
                    feedbackElement.textContent = 'Error al copiar';
                    feedbackElement.style.display = 'inline-block';
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 1500);
                }
                alert('No se pudo copiar el texto. Por favor, cÃ³pialo manualmente.');
            }
        } else {
            alert('Tu navegador no soporta la copia automÃ¡tica o no se encontrÃ³ el elemento. Por favor, selecciona y copia la direcciÃ³n manualmente.');
        }
    }


    /**
     * @MODIFICADO: Verifica la validez del formulario y habilita/deshabilita los botones.
     */
    function checkFormValidity() {
        const selectedRadio = document.querySelector('input[name="paymentMethod"]:checked');
        const isMethodSelected = selectedRadio !== null;
        const selectedMethodId = selectedRadio ? selectedRadio.value : null; // Obtener el ID seleccionado

        const emailInput = document.getElementById('email');
        const whatsappInput = document.getElementById('whatsappNumber');

        const isEmailFilled = emailInput && emailInput.value.trim() !== '';
        const isEmailValid = emailInput && emailInput.checkValidity();
        const isWhatsappFilled = whatsappInput && whatsappInput.value.trim() !== '';
        
        let areDetailsFilled = true; // Por defecto true para mÃ©todos sin comprobante visible.
        
        if (isAssistedFlow()) { // Flujo asistido
            // En flujo asistido, el botÃ³n de finalizar debe habilitarse solo si los contactos estÃ¡n llenos.
            finalizeBtn.disabled = !(isEmailFilled && isEmailValid && isWhatsappFilled);
            return;
        } 
        
        // LÃ³gica para los mÃ©todos que NO requieren comprobante visible.
        if (selectedMethodId === 'binance' || selectedMethodId === 'wallet') { 
            areDetailsFilled = true; // Siempre true, el comprobante es un input hidden o no aplica.
        } else {
            // LÃ³gica para mÃ©todos que SÃ requieren comprobante (pago-movil, zinli, binance-id)
            const uploadReceiptInput = document.getElementById('payment-receipt');
            areDetailsFilled = uploadReceiptInput && uploadReceiptInput.files.length > 0;
        }

        // Habilitar/deshabilitar el botÃ³n
        const formIsValid = isMethodSelected && isEmailFilled && isEmailValid && isWhatsappFilled && areDetailsFilled;
        finalizeBtn.disabled = !formIsValid;

        // Mostrar un mensaje de "Procesando" si es Plisio/Binance
        if (selectedMethodId === 'binance' && formIsValid) {
            finalizeBtn.textContent = 'Continuar a Plisio';
        } else if (selectedMethodId === 'wallet' && formIsValid) {
            finalizeBtn.textContent = 'Deducir de Wallet y Finalizar';
        } else {
            finalizeBtn.textContent = 'Finalizar Recarga';
        }
    }


    // 4. MANEJO DEL SUBMIT DEL FORMULARIO
    paymentForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        const emailInput = document.getElementById('email');
        const whatsappInput = document.getElementById('whatsappNumber');

        // ðŸŽ¯ Validaciones de campos de contacto (universales)
        if (!emailInput || emailInput.value.trim() === '' || !emailInput.checkValidity()) {
            alert('Por favor, ingresa un correo electrÃ³nico vÃ¡lido para recibir notificaciones.');
            emailInput.focus();
            return;
        }
        if (!whatsappInput || whatsappInput.value.trim() === '') {
            alert('Por favor, ingresa tu nÃºmero de WhatsApp para poder contactarte y completar la recarga.');
            return;
        }

        // LÃ³gica especial para recargas asistidas (TikTok, Telegram)
        if (isAssistedFlow()) {
            // ðŸ›‘ Ocultar el formulario y mostrar mensaje de Ã©xito temporal.
            const h2Title = document.querySelector('.form-container h2');
            const transactionSummary = document.getElementById('transaction-summary');
            if (h2Title) h2Title.style.display = 'none';
            if (transactionSummary) transactionSummary.style.display = 'none';

            paymentForm.style.display = 'none';
            whatsappMessageContainer.style.display = 'none';
            successMessageDisplay.style.display = 'block';
            localStorage.removeItem('transactionDetails');
            localStorage.removeItem('cartItems');

            setTimeout(() => {
                window.location.href = 'index.html';
            }, 5000);
            return;
        }

        // Obtener el precio final correcto (USDM si es Wallet, USD si es otro mÃ©todo USD)
        const finalPriceUSD = selectedPaymentMethod === 'wallet' ? parseFloat(transactionDetails.totalUSDM || 0) : parseFloat(transactionDetails.totalUSD || 0);

        if (finalPriceUSD <= 0) {
            alert('Error: El monto de la transacciÃ³n es invÃ¡lido. Por favor, revisa tu carrito.');
            return;
        }
        
        finalizeBtn.disabled = true;
        
        // ====================================================================
        // ðŸŽ¯ LÃ“GICA DE PAGO CON WALLET (CORRECCIÃ“N APLICADA AQUÃ)
        // ====================================================================
        if (selectedPaymentMethod === 'wallet') {
            
            // ðŸ›‘ CORRECCIÃ“N: Obtener y validar el token de sesiÃ³n (clave para solucionar el error)
            const sessionToken = localStorage.getItem('customSessionToken');
            
            if (!sessionToken) {
                // El error que el usuario estaba viendo
                alert('Error: No se encontrÃ³ la sesiÃ³n activa (token Bearer). Por favor, inicia sesiÃ³n de nuevo');
                finalizeBtn.disabled = false;
                finalizeBtn.textContent = 'Finalizar Recarga';
                return;
            }

            // a. Llamar a deduct-wallet-balance (El pago real)
            try {
                finalizeBtn.textContent = 'Deduciendo Saldo de Wallet...';
                
                const deductionResponse = await fetch('/.netlify/functions/deduct-wallet-balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // â­ï¸ CORRECCIÃ“N CLAVE: Adjuntar el token en la cabecera Authorization â­ï¸
                        'Authorization': `Bearer ${sessionToken}` 
                    },
                    body: JSON.stringify({
                        amountUSD: finalPriceUSD, 
                        email: emailInput.value.trim(),
                        whatsapp: whatsappInput.value.trim(),
                        cartDetails: JSON.stringify(Array.isArray(transactionDetails) ? transactionDetails : [transactionDetails]),
                    })
                });

                if (deductionResponse.ok) {
                    // Si la deducciÃ³n fue exitosa, pasamos a registrar la transacciÃ³n (process-payment)
                    // b. Llamar a process-payment para registrar la transacciÃ³n y notificar
                    
                    finalizeBtn.textContent = 'Notificando Pedido...';
                    
                    const processFormData = new FormData();
                    processFormData.append('paymentMethod', 'wallet');
                    processFormData.append('email', emailInput.value.trim());
                    processFormData.append('whatsappNumber', whatsappInput.value.trim());
                    // Enviamos la cadena de valor del input hidden
                    processFormData.append('paymentReceipt', 'Wallet_Deduction_Flow'); 
                    // AÃ±adir todos los datos de transacciÃ³n
                    processFormData.append('cartDetails', JSON.stringify(Array.isArray(transactionDetails) ? transactionDetails : [transactionDetails]));
                    processFormData.append('finalPrice', transactionDetails.finalPrice);
                    processFormData.append('currency', transactionDetails.currency);
                    processFormData.append('totalUSD', transactionDetails.totalUSD);
                    processFormData.append('totalVES', transactionDetails.totalVES);
                    processFormData.append('totalUSDM', transactionDetails.totalUSDM);


                    const processPaymentResponse = await fetch('/.netlify/functions/process-payment', {
                        method: 'POST',
                        body: processFormData
                    });
                    
                    if (processPaymentResponse.ok) {
                        // 3. Ã‰XITO COMPLETO (Pago y NotificaciÃ³n OK)
                        const h2Title = document.querySelector('.form-container h2');
                        const transactionSummary = document.getElementById('transaction-summary');
                        if (h2Title) h2Title.style.display = 'none';
                        if (transactionSummary) transactionSummary.style.display = 'none';
                        
                        paymentForm.style.display = 'none';
                        whatsappMessageContainer.style.display = 'none';
                        successMessageDisplay.style.display = 'block';
                        localStorage.removeItem('transactionDetails');
                        localStorage.removeItem('cartItems');
                        
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 5000);
                        
                    } else {
                        // 3. Ã‰XITO PARCIAL (Pago OK, NotificaciÃ³n fallida)
                        const errorData = await processPaymentResponse.json();
                        alert(`Â¡Pago con Wallet exitoso, pero fallÃ³ la notificaciÃ³n automÃ¡tica! Por favor, contacta a soporte con tu email (${emailInput.value.trim()}) para confirmar tu pedido y envÃ­anos la captura de tu pedido en Telegram.\nError: ${errorData.message || 'Error desconocido'}`);
                        console.error('Process Payment (NotificaciÃ³n) error after successful Wallet deduction:', errorData);

                        finalizeBtn.disabled = false;
                        finalizeBtn.textContent = 'Finalizar Recarga';
                    }
                    
                } else {
                    // 2. ERROR EN LA DEDUCCIÃ“N (Saldo insuficiente, token invÃ¡lido, etc.)
                    const errorData = await deductionResponse.json();
                    alert(`OcurriÃ³ un error en el pago con Wallet: ${errorData.message || deductionResponse.statusText}. Por favor, verifica tus datos e intÃ©ntalo de nuevo.`);
                    console.error('Wallet deduction error:', errorData);

                    finalizeBtn.disabled = false;
                    finalizeBtn.textContent = 'Finalizar Recarga';
                }
            } catch (error) {
                alert('Hubo un problema de conexiÃ³n con el servidor. Por favor, intÃ©ntalo de nuevo mÃ¡s tarde.');
                console.error('Network or client error during wallet deduction:', error);
                finalizeBtn.disabled = false;
                finalizeBtn.textContent = 'Finalizar Recarga';
            }
            return; 
        } 
        // ====================================================================
        // ðŸ›‘ FIN DE LÃ“GICA DE PAGO CON WALLET
        // ====================================================================


        // ====================================================================
        // LÃ“GICA DE PAGO CON PLISIO (REDIRECCIÃ“N)
        // ====================================================================
        if (selectedPaymentMethod === 'binance') {
            finalizeBtn.disabled = true;
            finalizeBtn.textContent = 'Creando Factura en Plisio...';
            
            const googleIdToSend = getGoogleIdFromTransaction();

            try {
                // Llamada a la funciÃ³n de Netlify para crear la factura de Plisio
                const response = await fetch('/.netlify/functions/create-plisio-invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: finalPriceUSD, // ðŸŽ¯ FIX 11: amount: usa el precio final (USD/USDM)
                        email: emailInput.value.trim(),
                        whatsapp: whatsappInput.value.trim(),
                        cartDetails: JSON.stringify(Array.isArray(transactionDetails) ? transactionDetails : [transactionDetails]),
                        googleId: googleIdToSend,
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.chargeUrl) {
                        console.log('Redirigiendo a Plisio:', data.chargeUrl);
                        window.location.href = data.chargeUrl; // RedirecciÃ³n inmediata a la pasarela
                    } else {
                        throw new Error('No se recibiÃ³ la URL de pago de Plisio.');
                    }
                } else {
                    const errorData = await response.json();
                    alert(`OcurriÃ³ un error al crear la factura de Plisio: ${errorData.message || response.statusText}`);
                    finalizeBtn.disabled = false;
                    finalizeBtn.textContent = 'Finalizar Recarga';
                }
            } catch (error) {
                console.error('Error en el flujo de Plisio:', error);
                alert('Error de conexiÃ³n o configuraciÃ³n al iniciar el pago con Plisio.');
                finalizeBtn.disabled = false;
                finalizeBtn.textContent = 'Finalizar Recarga';
            }
            return;
        }

        // ====================================================================
        // LÃ“GICA DE PAGO CON PAGO MÃ“VIL / TRANSFERENCIA (Flujo de comprobante)
        // ====================================================================
        if (selectedPaymentMethod === 'pago-movil' || selectedPaymentMethod === 'zinli' || selectedPaymentMethod === 'binance-id') {
            const uploadReceiptInput = document.getElementById('payment-receipt');
            if (!uploadReceiptInput || !uploadReceiptInput.files[0]) {
                alert('Por favor, sube un comprobante de pago.');
                finalizeBtn.disabled = false;
                finalizeBtn.textContent = 'Finalizar Recarga';
                return;
            }

            const formData = new FormData(paymentForm);

            // AÃ±adir detalles de la transacciÃ³n al FormData para el backend
            formData.append('cartDetails', JSON.stringify(Array.isArray(transactionDetails) ? transactionDetails : [transactionDetails]));
            formData.append('finalPrice', transactionDetails.finalPrice);
            formData.append('currency', transactionDetails.currency);
            formData.append('totalUSD', transactionDetails.totalUSD);
            formData.append('totalVES', transactionDetails.totalVES);
            formData.append('totalUSDM', transactionDetails.totalUSDM);


            // Llamar a la funciÃ³n de Netlify para procesar el pago (subir comprobante y notificar)
            try {
                finalizeBtn.textContent = 'Subiendo Comprobante...';

                const response = await fetch('/.netlify/functions/process-payment', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // Ã‰xito en el procesamiento
                    const h2Title = document.querySelector('.form-container h2');
                    const transactionSummary = document.getElementById('transaction-summary');
                    if (h2Title) h2Title.style.display = 'none';
                    if (transactionSummary) transactionSummary.style.display = 'none';

                    paymentForm.style.display = 'none';
                    whatsappMessageContainer.style.display = 'none';
                    successMessageDisplay.style.display = 'block';
                    localStorage.removeItem('transactionDetails');
                    localStorage.removeItem('cartItems'); 

                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 5000);
                } else {
                    const errorData = await response.json();
                    alert(`OcurriÃ³ un error: ${errorData.message || response.statusText}. Por favor, verifica tus datos e intÃ©ntalo de nuevo.`);
                    console.error('Server error:', errorData);
                    finalizeBtn.disabled = false;
                    finalizeBtn.textContent = 'Finalizar Recarga';
                }
            } catch (error) {
                alert('Hubo un problema de conexiÃ³n. Por favor, intÃ©ntalo de nuevo mÃ¡s tarde.');
                console.error('Network or client error:', error);
                finalizeBtn.disabled = false;
                finalizeBtn.textContent = 'Finalizar Recarga';
            }
        } else {
            // Manejar caso donde no se selecciona ningÃºn mÃ©todo
            alert('Por favor, selecciona un mÃ©todo de pago.');
            finalizeBtn.disabled = false;
            finalizeBtn.textContent = 'Finalizar Recarga';
        }
    });

    // 5. LÃ“GICA DE INICIALIZACIÃ“N (al cargar la pÃ¡gina)

    // LÃ³gica de Plisio para manejo de redirecciÃ³n (si vienes de una pasarela de pago)
    const urlParams = new URLSearchParams(window.location.search);
    const plisioStatus = urlParams.get('plisio_status');
    const h2Title = document.querySelector('.form-container h2');
    const transactionSummary = document.getElementById('transaction-summary');

    // ðŸ›‘ LÃ³gica para si Plisio nos devuelve un status de "processing" (Ã©xito)
    if (plisioStatus === 'processing' || plisioStatus === 'ok') { 
        console.log('Detectada redirecciÃ³n de Plisio exitosa. Activando mensaje de procesamiento.');
        
        // ðŸ›‘ LÃNEAS AÃ‘ADIDAS PARA OCULTAR ELEMENTOS
        if (h2Title) h2Title.style.display = 'none';
        if (transactionSummary) transactionSummary.style.display = 'none';

        // 1. Ocultar el formulario de comprobante de pago
        if (paymentForm) paymentForm.style.display = 'none';
        // 2. Ocultar la secciÃ³n de mensaje de WhatsApp (si existe)
        if (whatsappMessageContainer) whatsappMessageContainer.style.display = 'none';
        // 3. Mostrar el mensaje de Ã©xito (el cuadro de "Su recarga estÃ¡ siendo procesada...")
        if (successMessageDisplay) successMessageDisplay.style.display = 'block';
        
        // 4. Limpiar el localStorage (como respaldo)
        localStorage.removeItem('transactionDetails');
        localStorage.removeItem('cartItems'); 
        
        // 5. Iniciar la redirecciÃ³n automÃ¡tica a index.html despuÃ©s de 5 segundos
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 5000);
        // ðŸ›‘ Detener la ejecuciÃ³n del resto del script
        return; 
    }

    // El script principal de inicializaciÃ³n que corre si NO es una redirecciÃ³n de Plisio
    const storedDetails = localStorage.getItem('transactionDetails');
    if (storedDetails) {
        transactionDetails = JSON.parse(storedDetails);
        
        // APLICAR ARREGLO CLAVE: Si es un objeto singular (flujo antiguo), lo convertimos a array.
        if (!Array.isArray(transactionDetails)) {
            transactionDetails = [transactionDetails];
        }

        // Mover los listeners de los campos de contacto aquÃ­ para que estÃ©n activos siempre
        const emailInput = document.getElementById('email');
        const whatsappInput = document.getElementById('whatsappNumber');
        if (emailInput) emailInput.addEventListener('input', checkFormValidity);
        if (whatsappInput) whatsappInput.addEventListener('input', checkFormValidity);

        updateTransactionSummary(); // Esto calcula los totales y llama a updatePaymentMethods

        // LÃ³gica de copia al portapapeles (Universal)
        document.querySelectorAll('.copy-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = button.getAttribute('data-copy-target');
                const targetElement = document.getElementById(targetId);
                const feedbackId = targetId + '-copy-feedback';
                const feedbackElement = document.getElementById(feedbackId);
                copyToClipboard(targetElement, feedbackElement);
            });
        });
        
    } else {
        // No hay detalles de transacciÃ³n, redirigir
        alert('No se encontraron detalles de la transacciÃ³n. SerÃ¡s redirigido.');
        window.location.href = 'index.html';
    }

</script>
</body>
</html>